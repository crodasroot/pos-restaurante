<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taqueria de Lervy</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        /* --- ESTILOS CSS PARA DISE√ëO M√ìVIL Y EST√âTICA --- */
        :root {
            --color-primary: #121212; /* Fondo Muy Oscuro */
            --color-secondary: #1e1e1e; /* Fondo de Tarjetas y Secciones */
            --color-tertiary: #2e2e2e; /* Fondo de Inputs/Controles */
            --color-accent: #ffb703; /* Amarillo/Dorado de Acento (Mejor contraste) */
            --color-success: #2a9d8f; /* Verde-Azul para Cobro */
            --color-danger: #e76f51; /* Naranja-Rojo para Cancelar/Borrar */
            --color-info: #3498db; /* Azul para Info/Acciones Secundarias */
            --color-text-light: #f4f4f4;
            --color-text-dark: #1e1e1e;
            --mobile-padding: 15px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-primary);
            color: var(--color-text-light);
            -webkit-tap-highlight-color: transparent;
            font-size: 16px;
        }

        /* Contenedor Principal de la Aplicaci√≥n */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px; 
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        /* √Årea de Contenido */
        #content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--mobile-padding);
        }

        /* --- PESTA√ëAS Y NAVEGACI√ìN --- */
        #nav-bar {
display: flex; justify-content: space-around; 
            background-color: var(--color-secondary);
            border-top: 1px solid #333; 
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.5);
            /* Cambios clave para fijar */
            position: fixed;
            bottom: 0; 
            left: 0;
            width: 100%; /* Asegura que cubra todo el ancho */
            max-width: 600px; /* Limita al ancho del contenedor principal */
            margin: 0 auto; /* Centrar en el ancho m√°ximo */
            z-index: 100;
        }
        .tab-button {
           flex: 1; padding: 10px 0; text-align: center; border: none;
            background-color: transparent; color: #888; cursor: pointer;
            transition: all 0.2s ease-in-out; font-size: 14px;
            display: flex; flex-direction: column; align-items: center;
        }
        .tab-button.active { color: var(--color-accent); }
        .tab-button span { font-size: 20px; margin-bottom: 3px; }

        .page { display: none; padding-bottom: 20px; }
        .page.active { display: block; }
        h2 { 
            border-bottom: 2px solid var(--color-accent); 
            padding-bottom: 5px; 
            margin-top: 0; 
            color: var(--color-text-light); 
            font-size: 1.5em;
        }
        
        /* --- VISOR DE ORDEN ACTIVA EN PESTA√ëA MEN√ö --- */
        #active-order-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--color-secondary);
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: border-left 0.3s;
        }
        #active-order-display.inactive {
             border-left: 5px solid var(--color-danger);
             color: #aaa;
             font-style: italic;
        }
        #active-order-display:not(.inactive) {
            border-left: 5px solid var(--color-success);
        }
        #order-name-display { font-weight: bold; }
        #order-total-display { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--color-success);
        }

        /* --- CONTROLES Y FORMS GENERALES --- */
        #order-controls { 
            background-color: var(--color-secondary); padding: 10px; border-radius: 6px; 
            margin-bottom: 15px; display: flex; gap: 10px; align-items: center; 
            border: 1px solid #333;
        }
        #order-selector { 
            flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; 
            background-color: var(--color-tertiary); color: var(--color-text-light); 
        }
        .add-order-button { background-color: var(--color-info); color: var(--color-text-light); padding: 10px 15px; font-size: 1em; border: none; border-radius: 4px; }
        
        /* --- ESTILOS DE PRODUCTOS (MEN√ö) --- */
        #products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }
        .product-card {
            background-color: var(--color-secondary); border-radius: 10px; padding: 15px 10px;
            text-align: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer; transition: transform 0.15s, background-color 0.15s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .product-card:active { transform: scale(0.95); background-color: #333; }
        .product-card-name { font-size: 1em; margin: 5px 0 2px 0; font-weight: bold; }
        .product-card-price { font-size: 1.2em; color: var(--color-accent); font-weight: bold; }

        /* --- ESTILOS DE ORDEN Y RESUMEN --- */
        .order-item {
            background-color: var(--color-secondary); padding: 12px; border-radius: 8px; 
            margin-bottom: 10px; border-left: 4px solid var(--color-accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .qty-button {
            background-color: var(--color-accent); color: var(--color-text-dark);
            border: none; width: 32px; height: 32px; border-radius: 50%;
            font-size: 1.2em; cursor: pointer; margin: 0 8px; font-weight: bold;
        }
        #order-summary { 
            background-color: var(--color-secondary); padding: 18px; border-radius: 10px; 
            margin-top: 20px; border: 1px solid #333; 
        }
        #order-summary div { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .total-line { 
            font-size: 1.6em; font-weight: bold; color: var(--color-success); 
            padding-top: 15px; border-top: 2px dashed #333; 
        }

        /* --- BOTONES PRINCIPALES --- */
        .action-button { 
            width: 100%; padding: 18px; margin-top: 15px; border: none; border-radius: 8px; 
            font-size: 1.3em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; 
        }
        .checkout-button { background-color: var(--color-success); color: var(--color-text-light); } 
        .cancel-button { background-color: var(--color-danger); color: var(--color-text-light); } 

        /* --- ESTILOS DE ADMINISTRACI√ìN (CRUD y Backup) --- */
        .admin-form input, .admin-form button, .admin-form select {
            width: calc(100% - 20px); padding: 12px; margin-bottom: 10px;
            border-radius: 4px; border: 1px solid #555; background-color: var(--color-tertiary);
            color: var(--color-text-light); box-sizing: border-box;
        }
        .admin-form button[type="submit"] { background-color: var(--color-accent); color: var(--color-text-dark); }
        
        .product-item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #333; background-color: var(--color-secondary);
            margin-bottom: 5px; border-radius: 4px;
        }
        .product-item-actions button {
            background: none; border: none; cursor: pointer; color: var(--color-danger);
            margin-left: 10px; font-size: 1.1em;
        }

        /* Estilos espec√≠ficos para Backup */
        #backup-section {
            border: 1px solid #333; padding: 15px; border-radius: 8px;
            background-color: var(--color-secondary); margin-bottom: 20px;
        }
        .backup-button {
            width: 100%; padding: 12px; border-radius: 6px; font-weight: bold;
            border: none; cursor: pointer; margin-top: 8px;
        }
        #export-data-btn { background-color: var(--color-info); color: var(--color-text-light); }
        #import-file-input {
            width: 100%; margin-bottom: 10px; border: 1px solid #555;
            padding: 10px; background-color: var(--color-tertiary);
            /* Ocultar input file original para usar el bot√≥n de import */
            display: none; 
        }
        #import-data-btn { 
            background-color: var(--color-success); 
            color: var(--color-text-light); 
            margin-bottom: 10px; 
        }
        
        /* Mensaje de Estado (Toast) */
        #status-message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9); color: white; padding: 20px 30px;
            border-radius: 10px; z-index: 1000; display: none; text-align: center;
            font-size: 1.1em; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        
        /* Estilos de Historial (Revisados) */
        .history-list { list-style: none; padding: 0; }
        .history-item { 
            background-color: var(--color-secondary); padding: 15px; border-radius: 8px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; 
            align-items: center; border-left: 5px solid var(--color-success);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .history-item-date { font-size: 0.9em; color: #aaa; margin-top: 4px;}
        .history-item-date span { margin-right: 5px; color: var(--color-accent); }
        .history-item-total { font-size: 1.7em; font-weight: bold; color: var(--color-success); }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="status-message"></div>

    <div id="content-area">
        
        <div id="menu-page" class="page active">
            <h2>üçΩÔ∏è Taqueria De Lervy</h2>
            
            <div id="active-order-display" class="inactive">
                <span id="order-name-display">Selecciona o crea una orden</span>
                <span id="order-total-display">Q0.00</span>
            </div>

            <div id="products-grid">
                <p id="loading-products">Cargando men√∫...</p>
            </div>
        </div>

        <div id="order-page" class="page">
            <h2>üõí Gesti√≥n de √ìrdenes</h2>
            
            <div id="order-controls">
                <select id="order-selector"></select>
                <button id="new-order-btn" class="add-order-button" >+ Nueva Orden</button>
            </div>
            
            <div id="order-list">
                </div>

            <p id="empty-order" style="text-align: center; color: #aaa;">Selecciona una orden o crea una nueva.</p>


            <div id="order-summary" style="display: none;">
                <div><span>Subtotal:</span> <span id="subtotal-amount">Q0.00</span></div>
                <div><span>Impuestos (0%):</span> <span id="tax-amount">Q0.00</span></div>
                <div class="total-line"><span>Total:</span> <span id="total-amount">Q0.00</span></div>
            </div>

            <button id="checkout-btn" class="action-button checkout-button" style="display: none;">‚úÖ COBRAR ORDEN</button>
            <button id="cancel-btn" class="action-button cancel-button" style="display: none;">‚ùå CANCELAR ORDEN</button>
        </div>

<div id="history-page" class="page">
            <h2>üìú Historial de Ventas</h2>

            <div id="history-filters">
                <button id="filter-today-btn" class="add-order-button" style="width: 100%; margin-bottom: 10px;">üìÜ Filtrar por **HOY**</button>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="date" id="date-from" title="Desde" style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: var(--color-tertiary); color: var(--color-text-light);">
                    <input type="date" id="date-to" title="Hasta" style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: var(--color-tertiary); color: var(--color-text-light);">
                </div>
                <button id="filter-history-btn" class="add-order-button" style="width: 100%;">üîç Aplicar Rango de Fechas</button>
            </div>

            <ul id="history-list" class="history-list">
                <p id="loading-history">Cargando historial...</p>
            </ul>
        </div>
        
        <div id="admin-page" class="page">
            <h2>‚öôÔ∏è Gesti√≥n de Productos y Data</h2>
            
            <h3>‚ûï Agregar/Editar Producto</h3>
            <form id="product-form" class="admin-form">
                <input type="hidden" id="product-id">
                <input type="text" id="product-name" placeholder="Nombre del Producto" required>
                <input type="number" id="product-price" placeholder="Precio (Q)" step="0.01" min="0" required>
                <button type="submit" id="product-submit-btn">Guardar Producto</button>
            </form>
            
            <hr style="border-color:#333; margin: 20px 0;">

            <h3>üìã Men√∫ Actual</h3>
            <div id="product-list-admin">
                </div>
            
            <hr style="border-color:#333; margin: 20px 0;">
            
            <h3>üíæ Respaldo y Restauraci√≥n de Data</h3>
            <div id="backup-section">
                <h4>Exportar Data (Backup)</h4>
                <p style="font-size:0.9em; color:#aaa;">Descarga toda la base de datos (Men√∫, √ìrdenes, Ventas) como un archivo JSON.</p>
                <button id="export-data-btn" class="backup-button">‚¨áÔ∏è Exportar Data Completa</button>

                <hr style="border-color:#333; margin: 15px 0;">

                <h4>Importar Data (Restaurar)</h4>
                <p style="font-size:0.9em; color:var(--color-danger); font-weight: bold;">ADVERTENCIA: Esto SOBREESCRIBIR√Å todos los datos existentes.</p>
                <input type="file" id="import-file-input" accept=".json"> 
                <button id="import-data-btn" class="backup-button">‚¨ÜÔ∏è Importar y Restaurar Data</button>
            </div>
            
            <hr style="border-color:#333; margin: 20px 0;">
            
            <h3>üóëÔ∏è Limpieza de Datos</h3>
            <button id="clear-all-data-btn" class="action-button cancel-button" style="padding: 10px; margin-top: 5px;">üö® ELIMINAR TODOS LOS DATOS LOCALES</button>
        </div>
        
    </div>

    <nav id="nav-bar">
        <button class="tab-button active" data-page="menu-page">
            <span>&#9776;</span> Men√∫
        </button>
        <button class="tab-button" data-page="order-page">
            <span>&#128722;</span> √ìrdenes
        </button>
        <button class="tab-button" data-page="history-page">
            <span>&#128214;</span> Historial
        </button>
        <button class="tab-button" data-page="admin-page">
            <span>&#9881;</span> Admin
        </button>
    </nav>

</div>

<script>


function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // **CORRECCI√ìN:** Usar la ruta absoluta del repositorio
            navigator.serviceWorker.register('/pos-restaurante/sw.js') 
                .then(registration => {
                    console.log('ServiceWorker registrado con √©xito:', registration.scope);
                    //showStatus('PWA lista. Se puede instalar o usar sin conexi√≥n.', 4000);
                })
                .catch(error => {
                    // Si falla, es por un error de sintaxis en el sw.js
                    console.error('Fallo en el registro del ServiceWorker:', error);
                });
        });
    }
}

// Llama a la funci√≥n de registro al iniciar la app
registerServiceWorker();



    // --- CONFIGURACI√ìN DE DB Y VARIABLES GLOBALES ---
    const DB_NAME = 'POSDB';
    const DB_VERSION = 2; 
    const STORE_PRODUCTS = 'products';
    const STORE_SALES = 'sales';
    const STORE_ORDERS = 'orders'; 
    const ALL_STORES = [STORE_PRODUCTS, STORE_SALES, STORE_ORDERS];
    const LOCAL_STORAGE_ACTIVE_ORDER_ID = 'activeOrderId'; 
    const CURRENCY_SYMBOL = 'Q';

    let db;
    let PRODUCTS = []; 
    let activeOrderId = localStorage.getItem(LOCAL_STORAGE_ACTIVE_ORDER_ID) || null;
    const TAX_RATE = 0; 
    
    // --- REFERENCIAS DE ELEMENTOS HTML ---
    const elements = {
        productsGrid: document.getElementById('products-grid'),
        orderSelector: document.getElementById('order-selector'),
        newOrderBtn: document.getElementById('new-order-btn'),
        orderList: document.getElementById('order-list'),
        orderSummary: document.getElementById('order-summary'),
        subtotalAmount: document.getElementById('subtotal-amount'),
        taxAmount: document.getElementById('tax-amount'),
        totalAmount: document.getElementById('total-amount'),
        checkoutBtn: document.getElementById('checkout-btn'),
        cancelBtn: document.getElementById('cancel-btn'),
        historyList: document.getElementById('history-list'),
        emptyOrder: document.getElementById('empty-order'),
        statusMessage: document.getElementById('status-message'),
        loadingProducts: document.getElementById('loading-products'),
        loadingHistory: document.getElementById('loading-history'),
        
        // Administraci√≥n
        productForm: document.getElementById('product-form'),
        productId: document.getElementById('product-id'),
        productName: document.getElementById('product-name'),
        productPrice: document.getElementById('product-price'),
        productSubmitBtn: document.getElementById('product-submit-btn'),
        productListAdmin: document.getElementById('product-list-admin'),
        clearAllDataBtn: document.getElementById('clear-all-data-btn'),

        // Historial
        dateFrom: document.getElementById('date-from'),
        dateTo: document.getElementById('date-to'),
        filterHistoryBtn: document.getElementById('filter-history-btn'),
        filterTodayBtn: document.getElementById('filter-today-btn'),
        
        // Backup
        exportDataBtn: document.getElementById('export-data-btn'),
        importFileInput: document.getElementById('import-file-input'),
        importDataBtn: document.getElementById('import-data-btn'),
        
        // Display de Orden Activa
        activeOrderDisplay: document.getElementById('active-order-display'),
        orderNameDisplay: document.getElementById('order-name-display'),
        orderTotalDisplay: document.getElementById('order-total-display'),
    };

    // --- FUNCIONES DE UTILIDAD DE INTERFAZ Y FECHAS ---

    function showStatus(message, duration = 3000) {
        elements.statusMessage.innerHTML = message;
        elements.statusMessage.style.display = 'block';
        setTimeout(() => {
            elements.statusMessage.style.display = 'none';
        }, duration);
    }
    
    function showLoading(show) {
        if (show) {
            elements.statusMessage.innerHTML = 'Procesando... üîÑ';
            elements.statusMessage.style.display = 'block';
        } else {
            elements.statusMessage.style.display = 'none';
        }
    }

    /** Formatea un n√∫mero como moneda local (Q) */
    function formatCurrency(number) {
        return `${CURRENCY_SYMBOL}${parseFloat(number).toFixed(2)}`;
    }

    /** Devuelve el timestamp de inicio del d√≠a (medianoche). */
    function startOfDay(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        return d.getTime();
    }

    /** Devuelve el timestamp del final del d√≠a (un milisegundo antes de la medianoche siguiente). */
    function endOfDay(date) {
        const d = new Date(date);
        d.setHours(23, 59, 59, 999);
        return d.getTime();
    }
    
    // --- MANEJO DE INDEXEDDB ---

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => { reject('Error al abrir IndexedDB'); };
            request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_PRODUCTS)) { db.createObjectStore(STORE_PRODUCTS, { keyPath: 'id' }); }
                if (!db.objectStoreNames.contains(STORE_SALES)) { db.createObjectStore(STORE_SALES, { keyPath: 'id', autoIncrement: true }); }
                if (!db.objectStoreNames.contains(STORE_ORDERS)) { db.createObjectStore(STORE_ORDERS, { keyPath: 'id' }); }
            };
        });
    }

    function transaction(storeName, mode, callback) {
        return new Promise(async (resolve, reject) => {
            if (!db) await openDB(); 
            const tx = db.transaction(storeName, mode);
            const store = tx.objectStore(storeName);
            tx.oncomplete = () => resolve();
            tx.onerror = (event) => reject(event.target.error);
            callback(store, resolve, reject);
        });
    }

    // --- L√ìGICA DE PRODUCTOS (CRUD y Renderizado) ---
    
    async function getAllProductsFromDB() {
        await openDB();
        let products = [];
        await transaction(STORE_PRODUCTS, 'readonly', (store, resolve) => {
            const request = store.getAll();
            request.onsuccess = (event) => { products = event.target.result; resolve(); };
        });
        return products;
    }
    
    async function saveProduct(product) {
        await transaction(STORE_PRODUCTS, 'readwrite', (store) => { store.put(product); });
        PRODUCTS = await getAllProductsFromDB(); 
        renderProducts();
        renderAdminProducts(); 
    }

    async function deleteProduct(productId) {
        if (!confirm('¬øEst√°s seguro de ELIMINAR permanentemente este producto?')) return;
        await transaction(STORE_PRODUCTS, 'readwrite', (store) => { store.delete(productId); });
        showStatus('Producto eliminado.', 2000);
        PRODUCTS = await getAllProductsFromDB();
        renderProducts();
        renderAdminProducts();
    }
    
    async function fetchProducts() {
        elements.loadingProducts.style.display = 'block';
        PRODUCTS = await getAllProductsFromDB();
        
        if (PRODUCTS.length === 0) {
            elements.loadingProducts.textContent = 'Men√∫ vac√≠o. Agrega productos desde la pesta√±a "Admin".';
        } else {
            elements.loadingProducts.style.display = 'none';
        }
        
        renderProducts();
        renderAdminProducts(); 
    }

    function renderProducts() {
        elements.productsGrid.innerHTML = '';
        PRODUCTS.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('onclick', `addToOrder('${product.id}')`);
            card.innerHTML = `
                <div class="product-card-name">${product.name}</div>
                <div class="product-card-price">${formatCurrency(product.price)}</div>
            `;
            elements.productsGrid.appendChild(card);
        });
        updateActiveOrderDisplay(); 
    }

    function renderAdminProducts() {
        elements.productListAdmin.innerHTML = '';
        if (PRODUCTS.length === 0) {
            elements.productListAdmin.innerHTML = '<p>No hay productos en el men√∫.</p>';
            return;
        }

        PRODUCTS.forEach(product => {
            const row = document.createElement('div');
            row.className = 'product-item-row';
            row.innerHTML = `
                <div class="product-item-info">
                    <strong>${product.name}</strong> (${formatCurrency(product.price)})
                </div>
                <div class="product-item-actions">
                    <button onclick="editProduct('${product.id}')" title="Editar">&#9998;</button>
                    <button onclick="deleteProduct('${product.id}')" title="Borrar">&#10006;</button>
                </div>
            `;
            elements.productListAdmin.appendChild(row);
        });
    }

    function editProduct(productId) {
        const product = PRODUCTS.find(p => p.id === productId);
        if (product) {
            elements.productId.value = product.id;
            elements.productName.value = product.name;
            elements.productPrice.value = parseFloat(product.price).toFixed(2);
            elements.productSubmitBtn.textContent = 'Guardar Cambios';
            showStatus(`Editando: ${product.name}`, 1500);
            elements.productForm.scrollIntoView({ behavior: 'smooth' });
        }
    }


    // --- L√ìGICA DE √ìRDENES ABIERTAS (M√∫ltiples √ìrdenes) ---

    async function getOrder(orderId) {
        await openDB();
        return new Promise((resolve, reject) => {
            transaction(STORE_ORDERS, 'readonly', (store) => {
                const request = store.get(orderId);
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        });
    }

    async function saveOrder(order) {
        await transaction(STORE_ORDERS, 'readwrite', (store) => { store.put(order); });
    }

    async function deleteOrder(orderId) {
        await transaction(STORE_ORDERS, 'readwrite', (store) => { store.delete(orderId); });
    }

    async function getAllOpenOrders() {
        await openDB();
        let orders = [];
        await transaction(STORE_ORDERS, 'readonly', (store, resolve) => {
            const request = store.getAll();
            request.onsuccess = (event) => { orders = event.target.result; resolve(); };
        });
        return orders;
    }

    async function createNewOrder() {
        const newOrderId = 'ORDER_' + Date.now();
        let orderName = prompt("Ingresa el nombre de la nueva orden (Ej: Mesa 5, Cliente A):", `No. ${newOrderId.slice(-4)}: `);
        
        if (!orderName) {
            showStatus('Creaci√≥n de orden cancelada.', 1500);
            return;
        }

        const newOrder = {
            id: newOrderId,
            name: orderName,
            items: [],
            timestamp: Date.now()
        };
        
        await saveOrder(newOrder);
        setActiveOrder(newOrderId);
    }
    
    async function setActiveOrder(orderId) {
        activeOrderId = orderId;
        localStorage.setItem(LOCAL_STORAGE_ACTIVE_ORDER_ID, orderId);
        
        await renderOrderManagement();
        updateActiveOrderDisplay(); 
        
        const selectedOption = elements.orderSelector.options[elements.orderSelector.selectedIndex];
        if(selectedOption) {
            showStatus(`Orden "${selectedOption.text.split('(')[0].trim()}" activada.`, 1500);
        } else {
            showStatus('Orden activada.', 1500);
        }
    }

    async function addToOrder(productId) {
        if (!activeOrderId) {
            showStatus('Primero crea o selecciona una orden activa en la pesta√±a √ìrdenes.', 2500);
            return;
        }

        const product = PRODUCTS.find(p => p.id === productId);
        let order = await getOrder(activeOrderId);
        
        const existingItemIndex = order.items.findIndex(item => item.id === productId);

        if (existingItemIndex > -1) {
            order.items[existingItemIndex].qty++;
        } else {
            order.items.push({ 
                id: product.id,
                name: product.name,
                price: parseFloat(product.price), 
                qty: 1 
            });
        }
        
        await saveOrder(order);
        showStatus(`${product.name} agregado a la orden.`, 1500);
        renderOrderDetails(order);
        renderOrderManagement();
        updateActiveOrderDisplay();
    }

    async function updateItemQuantity(productId, change) {
        if (!activeOrderId) return;

        let order = await getOrder(activeOrderId);
        const itemIndex = order.items.findIndex(item => item.id === productId);

        if (itemIndex > -1) {
            order.items[itemIndex].qty += change;
            
            if (order.items[itemIndex].qty <= 0) {
                order.items.splice(itemIndex, 1);
            }
        }
        
        await saveOrder(order);
        renderOrderDetails(order);
        renderOrderManagement();
        updateActiveOrderDisplay();
    }

    function calculateTotal(order) {
        const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;
        return { subtotal, tax, total };
    }

    async function renderOrderManagement() {
        const openOrders = await getAllOpenOrders();
        elements.orderSelector.innerHTML = '';
        
        if (openOrders.length === 0) {
            elements.orderSelector.innerHTML = '<option value="">-- No hay √≥rdenes abiertas --</option>';
            activeOrderId = null;
            localStorage.removeItem(LOCAL_STORAGE_ACTIVE_ORDER_ID);
        } else {
            openOrders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.id;
                const { total } = calculateTotal(order);
                option.textContent = `${order.name} (${formatCurrency(total)})`;
                elements.orderSelector.appendChild(option);
            });

            if (activeOrderId && openOrders.some(o => o.id === activeOrderId)) {
                elements.orderSelector.value = activeOrderId;
            } else {
                activeOrderId = openOrders[0] ? openOrders[0].id : null;
                if (activeOrderId) elements.orderSelector.value = activeOrderId;
                if (activeOrderId) localStorage.setItem(LOCAL_STORAGE_ACTIVE_ORDER_ID, activeOrderId);
            }
        }
        
        const activeOrderData = activeOrderId ? await getOrder(activeOrderId) : null;
        renderOrderDetails(activeOrderData);
        updateActiveOrderDisplay(activeOrderData);
    }

    function renderOrderDetails(order) {
        elements.orderList.innerHTML = '';

        if (!order || !activeOrderId) {
            elements.emptyOrder.textContent = 'Selecciona una orden o crea una nueva para empezar.';
            elements.emptyOrder.style.display = 'block';
            elements.orderSummary.style.display = 'none';
            elements.checkoutBtn.style.display = 'none';
            elements.cancelBtn.style.display = 'none';
            return;
        }

        if (order.items.length === 0) {
            elements.emptyOrder.textContent = `La orden "${order.name}" est√° vac√≠a. Agrega productos.`;
            elements.emptyOrder.style.display = 'block';
            elements.orderSummary.style.display = 'none';
        } else {
            elements.emptyOrder.style.display = 'none';
            elements.orderSummary.style.display = 'block';
        }

        elements.checkoutBtn.style.display = 'block'; 
        elements.cancelBtn.style.display = 'block';
        
        order.items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'order-item';
            itemElement.innerHTML = `
                <div class="order-item-details">
                    <span class="order-item-name"><strong>${item.name}</strong></span>
                    <br>
                    <span>${item.qty} x ${formatCurrency(item.price)} = ${formatCurrency(item.price * item.qty)}</span>
                </div>
                <div class="order-item-controls">
                    <button class="qty-button" onclick="updateItemQuantity('${item.id}', 1)">+</button>
                    <span style="margin: 0 10px;">${item.qty}</span>
                    <button class="qty-button" onclick="updateItemQuantity('${item.id}', -1)">-</button>
                </div>
            `;
            elements.orderList.appendChild(itemElement);
        });

        const { subtotal, tax, total } = calculateTotal(order);
        elements.subtotalAmount.textContent = formatCurrency(subtotal);
        elements.taxAmount.textContent = formatCurrency(tax);
        elements.totalAmount.textContent = formatCurrency(total);
    }
    
    /**
     * Actualiza el visor de orden activa en la pesta√±a Men√∫.
     */
    async function updateActiveOrderDisplay(orderData = null) {
        let order = orderData;
        if (!order && activeOrderId) {
            order = await getOrder(activeOrderId);
        }

        if (order && activeOrderId) {
            const { total } = calculateTotal(order);
            elements.activeOrderDisplay.classList.remove('inactive');
            elements.orderNameDisplay.innerHTML = `Orden: <strong>${order.name}</strong>`;
            elements.orderTotalDisplay.textContent = formatCurrency(total);
        } else {
            elements.activeOrderDisplay.classList.add('inactive');
            elements.orderNameDisplay.innerHTML = `‚ö†Ô∏è No hay orden seleccionada`;
            elements.orderTotalDisplay.textContent = formatCurrency(0);
        }
    }


    // --- L√ìGICA DE VENTA/HISTORIAL ---

    async function checkoutOrder() {
        if (!activeOrderId) return;
        
        let order = await getOrder(activeOrderId);

        if (order.items.length === 0) {
            showStatus('La orden est√° vac√≠a. No se puede cobrar.', 2000);
            return;
        }

        const { total } = calculateTotal(order);
        if (!confirm(`¬øConfirmar el COBRO de la orden "${order.name}" por ${formatCurrency(total)}?`)) return;

        showLoading(true);
        
        try {
            const saleData = {
                timestamp: Date.now(),
                date: new Date().toLocaleString('es-ES'),
                total: total,
                details: order.items,
                orderName: order.name 
            };
            await transaction(STORE_SALES, 'readwrite', (store) => { store.add(saleData); });
            await deleteOrder(activeOrderId);
            showStatus(`Venta de ${order.name} registrada con √©xito! üéâ`, 3000);
            activeOrderId = null;
            await renderOrderManagement();
            updateActiveOrderDisplay(); 

        } catch (error) {
            console.error('Checkout Error:', error);
            showStatus(`‚ùå Error al cobrar: ${error.message}`, 5000);
        } finally {
            showLoading(false);
        }
    }

async function fetchHistory(startDateTimestamp = null, endDateTimestamp = null) {
    elements.loadingHistory.style.display = 'block';
    elements.historyList.innerHTML = '';
    showLoading(true);

    try {
        await openDB();
        let history = [];
        let totalSales = 0; // Inicializar acumulador de ventas

        await transaction(STORE_SALES, 'readonly', (store, resolve) => {
            // Usamos un cursor inverso ('prev') para mostrar las ventas m√°s recientes primero
            const request = store.openCursor(null, 'prev'); 
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const sale = cursor.value;
                    const saleTimestamp = sale.timestamp;
                    
                    let include = true;
                    
                    if (startDateTimestamp && saleTimestamp < startDateTimestamp) {
                        include = false;
                    }

                    if (endDateTimestamp && saleTimestamp > endDateTimestamp) {
                        include = false;
                    }

                    if (include) {
                        history.push(sale);
                        totalSales += parseFloat(sale.total); // ACUMULAR TOTAL
                    }
                    cursor.continue();
                } else {
                    resolve();
                }
            };
        });

        elements.loadingHistory.style.display = 'none';
        
        if (history.length === 0) {
             elements.historyList.innerHTML = '<p>No se encontraron ventas para este rango de fechas.</p>';
             return;
        }

        // 1. Mostrar la lista de ventas
        history.forEach(sale => {
            const item = document.createElement('li');
            item.className = 'history-item';
            const name = sale.orderName ? sale.orderName : `Venta #${sale.id.toString().slice(-4)}`;
            const saleDate = new Date(sale.timestamp);
            
            const timeStr = saleDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const dateStr = saleDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });

            item.innerHTML = `
                <div class="history-item-details">
                    <strong>${name}</strong>
                    <div class="history-item-date">
                        <span>&#128339;</span> ${dateStr} - ${timeStr}
                    </div>
                </div>
                <div class="history-item-total">${formatCurrency(sale.total)}</div>
            `;
            elements.historyList.appendChild(item);
        });

        // 2. Agregar el resumen y el bot√≥n de WhatsApp
        const summaryContainer = document.createElement('div');
        summaryContainer.style.cssText = 'padding: 10px 0; margin-top: 20px;';
        
        // Contenedor de Total
        const totalDisplay = document.createElement('div');
        totalDisplay.id = 'sales-grand-total';
        totalDisplay.style.cssText = `
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--color-success);
            color: var(--color-text-light);
            font-size: 1.6em;
            font-weight: bold;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        `;
        totalDisplay.innerHTML = `TOTAL NETO: ${formatCurrency(totalSales)}`;
        summaryContainer.appendChild(totalDisplay);

        // Bot√≥n de WhatsApp
        const whatsappBtn = document.createElement('button');
        whatsappBtn.className = 'action-button checkout-button'; // Reutilizar clase visual
        whatsappBtn.style.cssText = 'background-color: #25D366; font-size: 1.1em; padding: 12px;';
        whatsappBtn.innerHTML = 'üì≤ ENVIAR REPORTE POR WHATSAPP';
        // Pasar el total de ventas a la funci√≥n
        whatsappBtn.onclick = () => shareHistoryWhatsapp(totalSales, history.length, startDateTimestamp, endDateTimestamp);
        
        summaryContainer.appendChild(whatsappBtn);
        elements.historyList.appendChild(summaryContainer);

    } catch (error) {
        console.error('Fetch History Error:', error);
        elements.loadingHistory.textContent = '‚ùå Error al cargar historial desde el almacenamiento local.';
        showStatus('Error de conexi√≥n con el historial local.', 5000);
    } finally {
        showLoading(false);
    }
}
  /**
 * Genera el resumen y abre la URL de WhatsApp.
 * @param {number} totalAmount - Total de ventas.
 * @param {number} totalCount - Cantidad de ventas.
 * @param {number} startTs - Timestamp de inicio de filtro.
 * @param {number} endTs - Timestamp de fin de filtro.
 */
function shareHistoryWhatsapp(totalAmount, totalCount, startTs, endTs) {
    
    // Solicitar el n√∫mero de tel√©fono con el prefijo de Guatemala
    let phoneNumber = prompt("Ingresa el n√∫mero de tel√©fono para enviar el reporte (ej: 40051234):", "+502");

    if (!phoneNumber || phoneNumber.length < 9) {
        showStatus('Env√≠o de reporte cancelado o n√∫mero inv√°lido.', 2500);
        return;
    }

    // Asegurar que el n√∫mero de tel√©fono comience con +502 si no lo tiene
    if (!phoneNumber.startsWith('+502')) {
         phoneNumber = '+502' + phoneNumber.replace(/\D/g, '').slice(-8); // Limpiar y tomar los √∫ltimos 8 d√≠gitos
    }
    
    // Formato de fechas
    let dateRange = "Ventas Totales del Historial Completo";
    if (startTs && endTs) {
        const start = new Date(startTs).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        const end = new Date(endTs).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        
        if (startTs === startOfDay(new Date()).getTime() && endTs === endOfDay(new Date()).getTime()) {
             dateRange = "Reporte de Ventas de HOY";
        } else {
             dateRange = `Reporte de Ventas del ${start} al ${end}`;
        }
    } else if (startTs) {
         const start = new Date(startTs).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
         dateRange = `Ventas a partir del ${start}`;
    }

          // Generar el mensaje de WhatsApp
          const message = `
      *‚úÖ ${dateRange}*
      ---
      *üí∞ Total Generado:* ${formatCurrency(totalAmount)}
      *üî¢ Cantidad de √ìrdenes:* ${totalCount}
      ---
      
          `.trim();

          // Codificar el mensaje para la URL
          const encodedMessage = encodeURIComponent(message);
          
          // Crear la URL de WhatsApp
          const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
          
          // Abrir la ventana de WhatsApp
          window.open(whatsappUrl, '_blank');
      }

    // --- L√ìGICA DE BACKUP (EXPORTAR / IMPORTAR) ---

    async function exportData() {
        showLoading(true);
        try {
            await openDB();
            const data = {};
            
            for (const storeName of ALL_STORES) {
                let items = [];
                await transaction(storeName, 'readonly', (store, resolve) => {
                    const request = store.getAll();
                    request.onsuccess = (event) => {
                        items = event.target.result;
                        resolve();
                    };
                });
                data[storeName] = items;
            }
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `pos_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showStatus('‚úÖ Data exportada con √©xito!', 3000);

        } catch (error) {
            console.error('Export Error:', error);
            showStatus('‚ùå Error al exportar data.', 5000);
        } finally {
            showLoading(false);
        }
    }

    async function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm('‚ö†Ô∏è ADVERTENCIA: ¬øEst√° seguro de importar esta data? Esto BORRAR√Å y REEMPLAZAR√Å todos los datos actuales (Productos, √ìrdenes y Ventas).')) {
            elements.importFileInput.value = '';
            return;
        }

        showLoading(true);

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);

                await openDB();
                
                // Borrar datos actuales y restaurar
                for (const storeName of ALL_STORES) {
                    if (importedData[storeName]) {
                        await transaction(storeName, 'readwrite', (store) => {
                            store.clear(); // Borra todo en la store actual
                            // Usar 'add' para sales si son autoIncrement, 'put' si tienen keyPath definido (como products y orders)
                            if (storeName === STORE_SALES) {
                                importedData[storeName].forEach(item => store.add(item)); 
                            } else {
                                importedData[storeName].forEach(item => store.put(item)); 
                            }
                        });
                    }
                }
                
                // Limpiar el estado y reiniciar la aplicaci√≥n
                localStorage.removeItem(LOCAL_STORAGE_ACTIVE_ORDER_ID);
                await init();
                showStatus('‚úÖ Data importada y restaurada con √©xito!', 5000);

            } catch (error) {
                console.error('Import Error:', error);
                showStatus('‚ùå Error al importar. Aseg√∫rate de que el archivo sea un JSON v√°lido de respaldo.', 8000);
            } finally {
                showLoading(false);
                elements.importFileInput.value = ''; // Resetear el input
            }
        };
        reader.readAsText(file);
    }

    // --- MANEJO DE EVENTOS ---

    // Cambiar de pesta√±a
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => {
            const targetPageId = e.currentTarget.dataset.page;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(targetPageId).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            if (targetPageId === 'history-page') {
                fetchHistory(); 
                elements.dateFrom.value = '';
                elements.dateTo.value = '';

            } else if (targetPageId === 'order-page') {
                renderOrderManagement();
            } else if (targetPageId === 'menu-page') {
                updateActiveOrderDisplay(); 
            } else if (targetPageId === 'admin-page') {
                renderAdminProducts();
                elements.productForm.reset();
                elements.productId.value = '';
                elements.productSubmitBtn.textContent = 'Guardar Producto';
            }
        });
    });

    // Eventos de √ìrdenes
    elements.newOrderBtn.addEventListener('click', createNewOrder);
    elements.orderSelector.addEventListener('change', (e) => { setActiveOrder(e.target.value); });
    elements.checkoutBtn.addEventListener('click', checkoutOrder);
    elements.cancelBtn.addEventListener('click', async () => {
        if (!activeOrderId) return;
        let order = await getOrder(activeOrderId);
        if (confirm(`¬øEst√°s seguro de CANCELAR y ELIMINAR la orden "${order.name}"? Esta acci√≥n no se puede deshacer.`)) {
            await deleteOrder(activeOrderId);
            activeOrderId = null;
            await renderOrderManagement();
            updateActiveOrderDisplay(); 
            showStatus('Orden cancelada y eliminada.', 1500);
        }
    });

    // Eventos de Administraci√≥n
    elements.productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = elements.productId.value;
        const name = elements.productName.value.trim();
        const price = parseFloat(elements.productPrice.value);
        if (name && !isNaN(price) && price >= 0) {
            const product = { id: id || 'PROD_' + Date.now(), name: name, price: price.toFixed(2) };
            try {
                await saveProduct(product);
                elements.productForm.reset();
                elements.productId.value = '';
                elements.productSubmitBtn.textContent = 'Guardar Producto';
                showStatus(`"${name}" guardado exitosamente.`, 2500);
            } catch (error) {
                showStatus('Error al guardar el producto. üõë', 3000);
            }
        } else {
            showStatus('Por favor, ingresa un nombre y un precio v√°lido.', 2500);
        }
    });

    elements.clearAllDataBtn.addEventListener('click', () => {
        if (!confirm('‚ö†Ô∏è ADVERTENCIA: Se ELIMINAR√ÅN PERMANENTEMENTE TODAS las ventas, √≥rdenes abiertas y productos del men√∫. ¬øEst√°s seguro?')) { return; }
        indexedDB.deleteDatabase(DB_NAME);
        localStorage.clear();
        db = null; PRODUCTS = []; activeOrderId = null;
        init(); 
        showStatus('‚úÖ Todos los datos locales han sido ELIMINADOS y reiniciados.', 5000);
    });
    
    // Eventos de Filtro de Historial
    elements.filterTodayBtn.addEventListener('click', () => {
        const today = new Date();
        const todayISO = today.toISOString().split('T')[0];
        elements.dateFrom.value = todayISO;
        elements.dateTo.value = todayISO;
        fetchHistory(startOfDay(today), endOfDay(today));
    });

    elements.filterHistoryBtn.addEventListener('click', () => {
        const dateFromValue = elements.dateFrom.value;
        const dateToValue = elements.dateTo.value;
        
        if (!dateFromValue && !dateToValue) {
            fetchHistory(); 
            return;
        }

        if (!dateFromValue || !dateToValue) {
            showStatus('Debes seleccionar ambas fechas para filtrar por rango.', 3000);
            return;
        }

        const startTimestamp = startOfDay(new Date(dateFromValue));
        const endTimestamp = endOfDay(new Date(dateToValue));
        
        if (startTimestamp > endTimestamp) {
            showStatus('La fecha "Desde" no puede ser posterior a la fecha "Hasta".', 3000);
            return;
        }

        fetchHistory(startTimestamp, endTimestamp);
    });
    
    // Eventos de Backup
    elements.exportDataBtn.addEventListener('click', exportData);
    // Usar el bot√≥n de Importar para desencadenar el input file
    elements.importDataBtn.addEventListener('click', () => {
        elements.importFileInput.click();
    });
    elements.importFileInput.addEventListener('change', importData);

   // --- CONFIGURACI√ìN E INSTALACI√ìN DEL SERVICE WORKER (PWA) ---


// --- FIN CONFIGURACI√ìN SERVICE WORKER ---

// --- INICIALIZACI√ìN ---
    async function init() {
        try {
            // L√ìGICA DE REGISTRO DE SERVICE WORKER (PWA)
            // (¬°SE HA ELIMINADO window.addEventListener('load', ...)!)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker Registrado con √©xito:', reg.scope))
                    .catch(err => console.error('Fallo el registro de Service Worker:', err));
            } else {
                console.log('El navegador no soporta Service Workers.');
            }
            
            // L√≥gica de inicio de la app (IndexedDB, etc.)
            await openDB();
            await fetchProducts(); 
            await renderOrderManagement(); 
            updateActiveOrderDisplay(); 
        } catch (error) {
            showStatus(`Error cr√≠tico al iniciar DB: ${error}`, 10000);
            console.error(error);
        }
    }

   
    init();

     


</script>

</body>
</html>
